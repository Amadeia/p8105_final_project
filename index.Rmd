---
title: <center> Midterm Election 2018
author: <center> Amadeia Rector | Courtney Chan | Pei Yang Hsieh | Qiu Xia Guan | Francois Ban 
output: 
  html_document:
    theme: flatly
---
<div id="just-line-break"></div>
<br/>
<div id="line-break-and-tab"></div>

<center>
### Ted Cruz vs. Beto O'Rourke  

<div id="just-line-break"></div>
<br/>
<div id="line-break-and-tab"></div>

<center>
<img src="image/candidates.png" style="width:55%"> 

<div id="just-line-break"></div>
<br/>
<div id="line-break-and-tab"></div>

### 2018 Texas Midterm Election Results by County  

<div id="just-line-break"></div>
<br/>
<div id="line-break-and-tab"></div>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tigris)
library(rvest)
library(leaflet)
library(dplyr)
library(tidyverse)
library(purrr)

```

```{r cleaning data for use with map, include=FALSE, message=FALSE}

#original data
url = "https://www.nytimes.com/elections/results/texas-senate"
nytimes_data = read_html(url, col_types = "ccdd")

#convert votes and percent to numeric
table_county =  (nytimes_data %>% html_nodes(css = "table")) %>% 
  .[[2]] %>%
  html_table() %>% 
  slice(1:(n() - 1)) %>% 
  select(-Rpt.) %>% 
  janitor::clean_names()

#remove the commas in the numbers first
table_county$cruz <- gsub(",","",table_county$cruz)
table_county$o_rourke <- gsub(",","",table_county$o_rourke)
table_county$dikeman <- gsub(",","",table_county$dikeman)

table_county = 
  table_county %>% 
  mutate(cruz = as.numeric(cruz), o_rourke = as.numeric(o_rourke), dikeman = as.numeric(dikeman))

table_county$county = str_replace(table_county$county,"La Vaca", "Lavaca")
table_county$county = str_replace(table_county$county,"De Witt", "DeWitt")
#county names misspelled (was causing issues with merging later on)

#reading in topic searches by districts using google trend data
district_searches = read.csv("https://raw.githubusercontent.com/googletrends/data/master/Search_Data_US_Congressional_District_26Sep2018.csv")

TX_searches = 
  district_searches %>% janitor::clean_names() %>% 
  filter(state == "TX")

#reading in congress districts
id <- "1mpBjlmy5CThvrPGgAqlEP2x7OFvnF4VH" # google file ID
congress_district = read.csv(sprintf("https://docs.google.com/uc?id=%s&export=download", id))

congress_district$county_name = str_replace(congress_district$county_name,"Sterlin", "Sterling")
congress_district$county_name = str_replace(congress_district$county_name,"MuCulloch","McCulloch")
#misspelled counties discovered while exploring data when merging later on

#cleaning and merging all three files from NYT, congressional districts file, and district topic searches
TX_searches =
  TX_searches %>% 
  separate(code, into = c("remove_1", "district_num"), sep = "-") %>% 
  mutate(district_num = as.numeric(district_num)) %>% 
  select(district_num, most_searched = first, x2003_invasion_of_iraq:women_s_health) 

nested_congress =
  congress_district %>% 
  nest(county_name) 
	
merged_searches= merge(TX_searches, nested_congress, by="district_num", all=TRUE) %>% 
  unnest() 

#rename variable county_name
merged_searches = merged_searches %>% 
  select(district_num, county=county_name, everything())

merged_nyt_searches = merge(merged_searches, table_county, by= "county", all=TRUE)

gis = merged_nyt_searches %>% 
  select(county, most_searched, cruz, o_rourke, dikeman) %>% 
  mutate(cruz_orour_rat = cruz/o_rourke,
         status = as.numeric(cruz_orour_rat>=1),
         winner = ifelse(status==1, "Ted Cruz", "Beto O'Rourke"))

gis = unique(gis) 

gis = gis %>% 
nest(most_searched) 

listcollapse = function(x){
  paste(unlist(x), collapse = ", ")
}

gis = gis %>% 
  mutate( most_searched = map(data, listcollapse)) %>% 
  select(-data)

```

```{r GIS file merge, include=FALSE}
texas_counties = counties(state = "48",year = "2017") #Texas fips code is 48, using most recent census data, 2017

tx_midterms = geo_join(texas_counties, gis, "NAME", "county")
```

```{r specifying what goes into map, include=FALSE}
pal = colorFactor(c("blue", "red"), tx_midterms$status)

popup = paste(sep = "<br/>",
              paste0("<b>Winner: </b>", tx_midterms$winner),
              paste0("<b>County: </b>", tx_midterms$county),
              paste0("<b>Votes for Ted Cruz: </b>", tx_midterms$cruz),
              paste0("<b>Votes for Beto O'Rourke: </b>", tx_midterms$o_rourke),
              paste0("<b>Votes for Neal Dikeman: </b>", tx_midterms$dikeman),
              paste0("<b>Most searched topics over one month prior: </b>", tx_midterms$most_searched))
```

```{r making the map using leaflet, echo=FALSE}
leaflet(tx_midterms) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(fillColor= ~pal(status),
              color = "black",
              popup = popup,
              fillOpacity = 0.5,
              weight = 0.5) %>% 
  addLegend(position = "bottomleft",
            colors = c("blue", "red"),
            labels = c("Democrat", "Republican"),
            opacity = 1,
            title = "2018 Texas Senate Election Results")
```

</center>
---
title: "texas_interactive_map"
author: "Amadeia Rector"
date: "11/29/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tigris)
library(rvest)
library(leaflet)
library(dplyr)
library(tidyverse)
library(purrr)

```

```{r cleaning data for use with map}
merged_nyt_searches = read_csv(file ="./data/merged_nyt_searches.csv") #previously merged_nyt_searches dataframe into a csv file

gis = merged_nyt_searches %>% 
  select(county, most_searched, cruz, o_rourke, dikeman) %>% 
  mutate(cruz_orour_rat = cruz/o_rourke,
         status = as.numeric(cruz_orour_rat>=1),
         winner = ifelse(status==1, "Ted Cruz", "Beto O'Rourke"))

gis = unique(gis) 

gis = gis %>% 
nest(most_searched) 

listcollapse = function(x){
  paste(unlist(x), collapse = ", ")
}

gis = gis %>% 
  mutate( most_searched = map(data, listcollapse)) %>% 
  select(-data)

```

Cleaning data so as to merge with GIS...
```{r GIS file merge}
texas_counties = counties(state = "48",year = "2017") #Texas fips code is 48, using most recent census data, 2017

tx_midterms = geo_join(texas_counties, gis, "NAME", "county")
```

```{r specifying what goes into map}
pal = colorFactor(c("blue", "red"), tx_midterms$status)

popup = paste(sep = "<br/>",
              paste0("<b>Winner: </b>", tx_midterms$winner),
              paste0("<b>County: </b>", tx_midterms$county),
              paste0("<b>Votes for Ted Cruz: </b>", tx_midterms$cruz),
              paste0("<b>Votes for Beto O'Rourke: </b>", tx_midterms$o_rourke),
              paste0("<b>Votes for Neal Dikeman: </b>", tx_midterms$dikeman),
              paste0("<b>Most searched topics over one month prior: </b>", tx_midterms$most_searched))
```

```{r making the map using leaflet}
leaflet(tx_midterms) %>% 
  addProviderTiles("CartoDB.Positron") %>% 
  addPolygons(fillColor= ~pal(status),
              color = "black",
              popup = popup,
              fillOpacity = 0.5,
              weight = 0.5) %>% 
  addLegend(position = "bottomleft",
            colors = c("blue", "red"),
            labels = c("Democrat", "Republican"),
            opacity = 1,
            title = "2018 Texas Senate Election Results")
```
